<!DOCTYPE html>
<html>
  <head>
    <title>Live Stream</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="/assets/js/stream-webrtc.js"></script>
  </head>
  <body>
    <video id="input-video" style="height: 100vh; width: 100vw;" autoplay muted playsinline></video>

    <script>
      let whipClient = null;
      async function initStream() {
        try {
          const resp = await fetch('/api/stream/publish', { method: 'POST' });
          const { whipUrl } = await resp.json();

          if (!whipUrl) {
            alert('Failed to get Stream publish URL');
            return;
          }

          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: false,
          });

          const videoEl = document.getElementById('input-video');
          videoEl.srcObject = stream;
          videoEl.muted = true;
          videoEl.playsInline = true;
          await videoEl.play().catch(() => {});

          whipClient = new CloudflareStreamWHIPClient({ url: whipUrl, stream, videoEl });
          await whipClient.start();

        } catch (e) {
          console.error(e);
          alert('An error occurred. Check the console.');
        }
      }

      initStream();

      window.addEventListener('pagehide', () => {
        try {
          if (whipClient) whipClient.stop({ stopTracks: true });
        } catch {
        }
      });
    </script>
  </body>
</html>
